---
- name: Initialize test docker containers
  hosts: localhost
  roles:
    - role: 'provision_docker'
      provision_docker__inventory:
        - name: 'test_system_users_groups_centos7'
          image: 'tomashavlas/ansible-test:centos7'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
        - name: 'test_system_users_groups_debian8'
          image: 'tomashavlas/ansible-test:debian8'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
  post_tasks:
    - name: Wait for SSH connection to docker containers
      wait_for:
        host: '{{ hostvars[item.name]["ansible_ssh_host"] }}'
        port: 22
        timeout: 30
        connect_timeout: 30
      with_items: '{{ provision_docker__inventory }}'
  tags: [ 'initialize-docker' ]

- name: Run system_users role NAMEME test scenario
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Create test helper groups
      group:
        name: '{{ item }}'
        state: 'present'
      with_items:
        - 'test1grp1'
        - 'test1grp2'
        - 'test1grp3'
        - 'test1grp4'
        - 'test1grp5'
        - 'test1grp6'
      changed_when: False
      tags: [ 'pre-test' ]
    - name: Create sample test users
      user:
        name: '{{ item }}'
        groups: 'test1grp5,test1grp6'
        state: 'present'
      with_items:
        - 'sample1_1'
        - 'sample1_2'
        - 'sample1_3'
        - 'sample1_4'
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Test system user with appended groups
      user:
        name: 'sample1_1'
        groups: 'test1grp1,test1grp2,test1grp5,test1grp6'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced groups
      user:
        name: 'sample1_2'
        groups: 'test1grp1,test1grp2'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with appended empty groups
      user:
        name: 'sample1_3'
        groups: 'test1grp5,test1grp6'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced empty groups
      user:
        name: 'sample1_4'
        groups: ''
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'system_users'
        system_users__list:
          - name: 'sample1_1'
            append: 'yes'
            groups:
              - 'test1grp1'
              - 'test1grp2'
          - name: 'sample1_2'
            append: 'no'
            groups:
              - 'test1grp1'
              - 'test1grp2'
          - name: 'sample1_3'
            append: 'yes'
            groups: []
          - name: 'sample1_4'
            append: 'no'
            groups: []
        system_users__default_groups_list: []
        system_users__default_groups_append: True

- name: Run system_users role NAMEME test scenario
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Create test helper groups
      group:
        name: '{{ item }}'
        state: 'present'
      with_items:
        - 'test2grp1'
        - 'test2grp2'
        - 'test2grp3'
        - 'test2grp4'
        - 'test2grp5'
        - 'test2grp6'
      changed_when: False
      tags: [ 'pre-test' ]
    - name: Create sample test users
      user:
        name: '{{ item }}'
        groups: 'test2grp5,test2grp6'
        state: 'present'
      with_items:
        - 'sample2_1'
        - 'sample2_2'
        - 'sample2_3'
        - 'sample2_4'
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Test system user with appended groups
      user:
        name: 'sample2_1'
        groups: 'test2grp1,test2grp2'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced groups
      user:
        name: 'sample2_2'
        groups: 'test2grp1,test2grp2'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with appended empty groups
      user:
        name: 'sample2_3'
        groups: ''
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced empty groups
      user:
        name: 'sample2_4'
        groups: ''
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'system_users'
        system_users__list:
          - name: 'sample2_1'
            append: 'yes'
            groups:
              - 'test2grp1'
              - 'test2grp2'
          - name: 'sample2_2'
            append: 'no'
            groups:
              - 'test2grp1'
              - 'test2grp2'
          - name: 'sample2_3'
            append: 'yes'
            groups: []
          - name: 'sample2_4'
            append: 'no'
            groups: []
        system_users__default_groups_list: []
        system_users__default_groups_append: False

- name: Run system_users role NAMEME test scenario
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Create test helper groups
      group:
        name: '{{ item }}'
        state: 'present'
      with_items:
        - 'test3grp1'
        - 'test3grp2'
        - 'test3grp3'
        - 'test3grp4'
        - 'test3grp5'
        - 'test3grp6'
      changed_when: False
      tags: [ 'pre-test' ]
    - name: Create sample test users
      user:
        name: '{{ item }}'
        groups: 'test3grp5,test3grp6'
        state: 'present'
      with_items:
        - 'sample3_1'
        - 'sample3_2'
        - 'sample3_3'
        - 'sample3_4'
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Test system user with appended groups
      user:
        name: 'sample3_1'
        groups: 'test3grp1,test3grp2,test3grp3,test3grp4,test3grp5,test3grp6'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced groups
      user:
        name: 'sample3_2'
        groups: 'test3grp1,test3grp2'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with appended empty groups
      user:
        name: 'sample3_3'
        groups: 'test3grp3,test3grp4,test3grp5,test3grp6'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced empty groups
      user:
        name: 'sample3_4'
        groups: ''
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'system_users'
        system_users__list:
          - name: 'sample3_1'
            append: 'yes'
            groups:
              - 'test3grp1'
              - 'test3grp2'
          - name: 'sample3_2'
            append: 'no'
            groups:
              - 'test3grp1'
              - 'test3grp2'
          - name: 'sample3_3'
            append: 'yes'
            groups: []
          - name: 'sample3_4'
            append: 'no'
            groups: []
        system_users__default_groups_list:
          - 'test3grp3'
          - 'test3grp4'
        system_users__default_groups_append: True

- name: Run system_users role NAMEME test scenario
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Create test helper groups
      group:
        name: '{{ item }}'
        state: 'present'
      with_items:
        - 'test4grp1'
        - 'test4grp2'
        - 'test4grp3'
        - 'test4grp4'
        - 'test4grp5'
        - 'test4grp6'
      changed_when: False
      tags: [ 'pre-test' ]
    - name: Create sample test users
      user:
        name: '{{ item }}'
        groups: 'test4grp5,test4grp6'
        state: 'present'
      with_items:
        - 'sample4_1'
        - 'sample4_2'
        - 'sample4_3'
        - 'sample4_4'
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Test system user with appended groups
      user:
        name: 'sample4_1'
        groups: 'test4grp1,test4grp2,test4grp3,test4grp4'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced groups
      user:
        name: 'sample4_2'
        groups: 'test4grp1,test4grp2'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with appended empty groups
      user:
        name: 'sample4_3'
        groups: 'test4grp3,test4grp4'
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
    - name: Test system user with replaced empty groups
      user:
        name: 'sample4_4'
        groups: ''
        state: 'present'
      register: 'test_result'
      failed_when: ((test_result.failed is defined and test_result.failed) or
                    (test_result.changed is defined and test_result.changed))
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'system_users'
        system_users__list:
          - name: 'sample4_1'
            append: 'yes'
            groups:
              - 'test4grp1'
              - 'test4grp2'
          - name: 'sample4_2'
            append: 'no'
            groups:
              - 'test4grp1'
              - 'test4grp2'
          - name: 'sample4_3'
            append: 'yes'
            groups: []
          - name: 'sample4_4'
            append: 'no'
            groups: []
        system_users__default_groups_list:
          - 'test4grp3'
          - 'test4grp4'
        system_users__default_groups_append: False
